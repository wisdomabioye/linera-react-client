<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Linera Client - Headless Browser</title>

  <!-- Import map to resolve React from CDN -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime"
      }
    }
  </script>
</head>
<body>
  <h1>Linera Client (Headless)</h1>
  <div id="status">Initializing...</div>

  <script type="module">
    console.log('[Headless] Starting module load...');

    try {
      // Import from the local copy of the module
      const LineraReactClient = await import('./linera-client.mjs');
      console.log('[Headless] Module loaded successfully!', Object.keys(LineraReactClient));

      // Global Linera client instance
      let lineraClient = null;
      let lineraApplications = new Map();

    // Initialize the Linera client
    async function initializeLinera(config) {
      try {
        console.log('[Headless] Initializing Linera client with config:', config);

        // Create client using the imported function
        lineraClient = LineraReactClient.createLineraClient({
          faucetUrl: config.faucetUrl,
          skipProcessInbox: config.skipProcessInbox || true,
        });

        // Initialize in read-only mode
        await lineraClient.initializeReadOnly();

        const state = lineraClient.getState();
        console.log('[Headless] Client initialized:', state);

        document.getElementById('status').textContent =
          `✅ Initialized (Mode: ${state.mode}, Chain: ${state.publicChainId})`;

        return {
          success: true,
          state: state
        };
      } catch (error) {
        console.error('[Headless] Initialization failed:', error);
        document.getElementById('status').textContent = `❌ Error: ${error.message}`;
        return {
          success: false,
          error: error.message
        };
      }
    }

    // Get or create application client
    async function getApplication(appId) {
      try {
        if (!lineraClient) {
          throw new Error('Client not initialized');
        }

        // Check cache
        if (lineraApplications.has(appId)) {
          console.log('[Headless] Using cached application:', appId);
          return lineraApplications.get(appId);
        }

        // Create new application client
        console.log('[Headless] Creating application client:', appId);
        const app = await lineraClient.getApplication(appId);

        if (!app) {
          throw new Error('Failed to create application client');
        }

        // Cache it
        lineraApplications.set(appId, app);
        return app;
      } catch (error) {
        console.error('[Headless] Failed to get application:', error);
        throw error;
      }
    }

    // Execute GraphQL query
    async function executeQuery(appId, query, options = {}) {
      try {
        console.log('[Headless] Executing query on app:', appId);
        const app = await getApplication(appId);
        const result = await app.public.query(query, options);
        console.log('[Headless] Query result:', result);
        return result;
      } catch (error) {
        console.error('[Headless] Query failed:', error);
        throw error;
      }
    }

    // Execute system mutation
    async function executeSystemMutation(appId, mutation, options = {}) {
      try {
        console.log('[Headless] Executing system mutation on app:', appId);
        const app = await getApplication(appId);
        const result = await app.public.systemMutate(mutation, options);
        console.log('[Headless] Mutation result:', result);
        return result;
      } catch (error) {
        console.error('[Headless] Mutation failed:', error);
        throw error;
      }
    }

    // Get client state
    function getClientState() {
      if (!lineraClient) {
        return { initialized: false };
      }
      return lineraClient.getState();
    }

    // Get chain
    async function getChain(chainId) {
      try {
        if (!lineraClient) {
          throw new Error('Client not initialized');
        }
        console.log('[Headless] Getting chain:', chainId);
        return await lineraClient.getChain(chainId);
      } catch (error) {
        console.error('[Headless] Failed to get chain:', error);
        throw error;
      }
    }

    // Get chain application
    async function getChainApplication(chainId, appId) {
      try {
        if (!lineraClient) {
          throw new Error('Client not initialized');
        }
        console.log('[Headless] Getting chain application:', chainId, appId);
        return await lineraClient.getChainApplication(chainId, appId);
      } catch (error) {
        console.error('[Headless] Failed to get chain application:', error);
        throw error;
      }
    }

      // Expose functions to window for Puppeteer
      window.LineraProxy = {
        initializeLinera,
        getApplication,
        executeQuery,
        executeSystemMutation,
        getClientState,
        getChain,
        getChainApplication
      };

      console.log('[Headless] Linera proxy functions ready');
    } catch (error) {
      console.error('[Headless] Failed to load module:', error);
      console.error('[Headless] Error stack:', error.stack);
      console.error('[Headless] Error details:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
      document.getElementById('status').textContent = `❌ Failed to load: ${error.message}`;

      // Set a dummy object so Puppeteer doesn't timeout
      window.LineraProxy = { error: error.message };
    }
  </script>
</body>
</html>
