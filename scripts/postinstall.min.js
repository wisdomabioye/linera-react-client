#!/usr/bin/env node
const fs=require("fs"),path=require("path"),colors={reset:"[0m",green:"[32m",yellow:"[33m",red:"[31m",cyan:"[36m",gray:"[90m"};function log(e,r="reset"){console.log(`${colors[r]}${e}${colors.reset}`)}function isCI(){return!!(process.env.CI||process.env.CONTINUOUS_INTEGRATION||process.env.BUILD_NUMBER||process.env.GITHUB_ACTIONS||process.env.GITLAB_CI||process.env.CIRCLECI)}function findProjectRoot(){let e=process.cwd();if(e.includes("node_modules")){const r=e.split(path.sep),n=r.lastIndexOf("node_modules");n>0&&(e=r.slice(0,n).join(path.sep))}return e}function detectFramework(e){try{const r=path.join(e,"package.json");if(!fs.existsSync(r))return"unknown";const n=JSON.parse(fs.readFileSync(r,"utf8")),o={...n.dependencies,...n.devDependencies};return o.next?"nextjs":o.vite?"vite":o["react-scripts"]?"cra":"unknown"}catch(e){return log(`Warning: Failed to detect framework: ${e.message}`,"yellow"),"unknown"}}function getPublicDir(e){return"public"}function getUserConfig(e){try{const r=path.join(e,"package.json");if(!fs.existsSync(r))return{};return JSON.parse(fs.readFileSync(r,"utf8")).lineraConfig||{}}catch(e){return{}}}function copyDir(e,r){if(!fs.existsSync(e))throw new Error(`Source directory not found: ${e}`);fs.existsSync(r)||fs.mkdirSync(r,{recursive:!0});const n=fs.readdirSync(e,{withFileTypes:!0});let o=0;for(const t of n){const n=path.join(e,t.name),i=path.join(r,t.name);t.isDirectory()?(fs.existsSync(i)||fs.mkdirSync(i,{recursive:!0}),o+=copyDir(n,i)):(fs.copyFileSync(n,i),o++)}return o}function main(){if(log("\n[Linera React SDK] Post-install setup","cyan"),log("".repeat(50),"gray"),isCI())return log("ï¿½ Skipping in CI environment","yellow"),void log("  Run manually if needed: node node_modules/@linera/react-sdk/scripts/postinstall.js","gray");const e=findProjectRoot();log(`Project root: ${e}`,"gray");const r=getUserConfig(e);if(!0===r.skipPostinstall)return log("ï¿½ Skipped (skipPostinstall = true in package.json)","yellow"),void log("  To copy files manually, run: node node_modules/@linera/react-sdk/scripts/postinstall.js","gray");const n=detectFramework(e);log(`Framework detected: ${n}`,"gray");const o=r.publicDir||getPublicDir(n),t=r.targetDir||"linera",i=[path.join(e,"node_modules","@linera","client","dist"),path.join(__dirname,"..","..","@linera","client","dist"),path.join(__dirname,"..","..","..","@linera","client","dist")],s=i.find(e=>fs.existsSync(e))||i[0],l=path.join(e,o,t);log(`Source: ${path.relative(e,s)}`,"gray"),log(`Target: ${path.relative(e,l)}`,"gray"),log("","reset");try{if(!fs.existsSync(s))return log("ï¿½ Source files not found","yellow"),log("  This is expected if @linera/client is not yet installed","gray"),void log("  Files will be copied after @linera/client is installed","gray");log("Copying Linera assets...","cyan");log(` Successfully copied ${copyDir(s,l)} files to ${path.relative(e,l)}`,"green"),log("","reset"),log("Next steps:","cyan"),log("  1. Ensure your bundler serves files from the public directory","gray"),log("  2. Configure required headers (see documentation)","gray"),log("","reset")}catch(e){log(" Failed to copy Linera assets","red"),log(`  Error: ${e.message}`,"gray"),log("","reset"),log("Manual copy instructions:","yellow"),log(`  1. Copy from: ${s}`,"gray"),log(`  2. Copy to: ${l}`,"gray"),log("  3. Or run: npm run linera:copy","gray"),log("","reset")}}require.main===module&&main(),module.exports={copyDir:copyDir,detectFramework:detectFramework,getPublicDir:getPublicDir};